<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-core-style-classes/at-core-style-classes.html">
<link rel="import" href="../at-carbon-button/at-carbon-button.html">
<link rel="import" href="../at-core-modal/at-core-modal.html">
<link rel="import" href="../at-core-activity/at-core-activity.html">

<script src="lib/js-yaml.js"></script>

<dom-module id="at-core-modal-element">
  <template>
    <style include="at-core-style-classes">
      :host {
        display: block;
        box-sizing: border-box;
      }

      .cancel-btn {
        --at-carbon-button: {
          background-color: var(--at-light-blue);
          color: var(--at-background-text-color);
        }
      }

      .ok-btn {
        --at-carbon-button: {
          background-color: var(--at-green);
          color: var(--at-background-text-color);
        }
      }
    </style>
    <at-core-media-query id="mediaQuery" query="(min-width: 800px)" on-query-matches-changed="_handleQueryMatches"></at-core-media-query>
    <div id="messages" class="font-body1"></div>

    <at-core-modal id="coreModal" on-close-modal="_handleCloseModal" wide$="[[wide]]">
      <div id="modalContent" class$="[[elementClass]]">
        <div id="buttonContainer" class="layout-horizontal layout-center-justified" hidden>
          <at-carbon-button raised class="cancel-btn" label="Cancel" on-tap="_handleCancelButtonTap"></at-carbon-button>
          <at-carbon-button id="okButton" disabled raised class="ok-btn" label="OK" on-tap="_handleOkButtonTap"></at-carbon-button>
        </div>
      </div>
    </at-core-modal>

    <at-core-activity id="schemaActivity" url="[[schemaUrl]]" content-type="text/plain" handle-as="text" on-response="_handleSchemaActivityResponse"
      on-error="_handleSchemaActivityError"></at-core-activity>
  </template>
</dom-module>
<script>
  Polymer({
    is: "at-core-modal-element",
    properties: {

      elementName: {
        type: String,
        value: ''
      },

      elementClass: {
        type: String,
        value: 'm'
      },

      schemaUrl: {
        type: String,
        value: ''
      },

      wide: {
        type: Boolean,
        value: false,
      },

      schema: {
        type: Object,
        value: function() {
          return {
            properties: {}
          };
        },
        observer: '_schemaChanged'
      },

      value: {
        type: Object,
        value: function() {
          return {};
        },
        observer: '_valueChanged'
      }
    },

    observers: [
      '_clearError(elementName, schemaUrl)'
    ],

    _clearError: function(elementName, schemaUrl) {
      this._setError("");
    },

    // 
    // public api
    // 
    open: function() {
      // one can set invalid schema or value before open is called; in that case do not open modal so that error messages are visible
      if (this._hasError()) return;

      // _initialize will return undefined if elementName or schemaUrl property is invalid
      if (!this._initialize()) return;

      this.$.coreModal.open();
    },

    close: function(reason) {
      this.$.coreModal.close(reason);
    },

    ready: function() { },

    // 
    // private api
    // 
    _initialize: function() {
      if (!this._isString(this.elementName)) {
        this._setError('Component name is not a string.');
        return;
      }

      if (!this.elementName.length) {
        this._setInformation('Component name is empty.');
        return;
      }

      if (!this._isString(this.schemaUrl)) {
        this._setError('schemaUrl is not a string.');
        return;
      }

      // check if element with elementName is already rendered
      var elt = this._getRenderedElement();
      if (!elt) {
        // if not import and render it
        this._importAndRender();
        return true;
      }

      // check if this.elementName property changed
      var importUrl = this._computeImportUrl(this.elementName);
      var elementName = this._computeElementName(importUrl);

      if (elt.is !== elementName) {
        // elementName changed; remove old element 
        Polymer.dom(this.$.modalContent).removeChild(elt);
        elt = null;
        // import new element and re-render
        this._importAndRender();
        return true;
      }

      // request to fetch schema from schemaUrl should not be sent before open is called
      // if schemaUrl changed between calls to .open() fetch new schema
      // if request was sent return
      if (this._fetchSchemaFromUrl(elt)) return true;

      // set value on elt
      this._setEltValue(elt);

      // clear validation errors from UI, because validation errors should be displayed only as result of user interaction
      var isValid = elt.validate(false);
      // if element is invalid disable ok button
      this.toggleAttribute('disabled', !isValid, this.$.okButton);

      return true;
    },

    _importAndRender: function() {
      this._setPlaceholder();

      var importUrl = this._computeImportUrl(this.elementName);
      var self = this;

      if (!this._boundHandleImportSuccess) {
        this._boundHandleImportSuccess = this._handleImportSuccess.bind(this);
      }

      this.importHref(importUrl,
        this._boundHandleImportSuccess,
        function(event) {
          self._setError("An error occured while importing " + importUrl);
          // modal is open at this point; close it so that error message is visible
          self.$.coreModal.close();
          this._clearPlaceholder();

        }, true);
    },

    _handleImportSuccess: function(event) {
      var elementName = this._computeElementName(event.target.href);
      var elt = this.create(elementName);

      if (!elt.properties.hasOwnProperty('value')) {
        this._setError('Element ' + elementName + ' does not have value property');
        // modal is open at this point; close it so that error message is visible
        this.$.coreModal.close();
        return;
      }

      if (!this._isFunction(elt.validate)) {
        this._setError('Element ' + elementName + ' does not have validate function');
        // modal is open at this point; close it so that error message is visible
        this.$.coreModal.close();
        return;
      }

      if (this._fetchSchemaFromUrl(elt)) {
        // keep reference of created element for latter use
        this._uiElts.renderedElt = elt;
        return;
      }

      this._renderUI(elt);
    },

    _fetchSchemaFromUrl: function(elt) {
      // if elt is an element that doesn't have schema property sending the request doesn't make sense
      var hasSchemaProp = this._isObject(elt.properties) && elt.properties.hasOwnProperty('schema');
      if (!hasSchemaProp) return false;

      var schemaUrlChanged = this._lastSchemaUrl !== this.schemaUrl;
      if (!schemaUrlChanged) return false;

      this._lastSchemaUrl = this.schemaUrl;
      if (!this.schemaUrl.length) return false;

      this.$.schemaActivity.generateRequest();
      return true;
    },

    _handleSchemaActivityError: function(error) {
      // close modal and clear placeholder, because next time _initialize is called placeholder should be set
      this.$.coreModal.close();
      this._clearPlaceholder();
    },

    _handleSchemaActivityResponse: function(response) {
      var newSchemaStr = response.detail;

      try {
        var newSchema = JSON.parse(newSchemaStr);
      } catch (e) {
        // try yaml
        try {
          newSchema = window.jsyaml.load(newSchemaStr);
        } catch (e) {
          this._setError('Data returned by remote service is not a json string nor yaml string.');
          // close modal and clear placeholder, because next time _initialize is called placeholder should be set
          this.$.coreModal.close();
          this._clearPlaceholder();
          return;
        }
      }

      if (!newSchema.hasOwnProperty('properties')) {
        this._setError('Schema must be an object that has properties property as object, or the JSON string of the former.');
        // close modal and clear placeholder, because next time _initialize is called placeholder should be set
        this.$.coreModal.close();
        this._clearPlaceholder();
        return;
      }

      // this will trigger _schemaChanged but since schemaUrl is set _schemaChanged will return immediatelly
      this.schema = newSchema;

      var elt = this._uiElts.renderedElt;
      this._uiElts.renderedElt = null;
      this._renderUI(elt);
    },

    _renderUI: function(elt) {
      // we need to assign elt.schema here for when elt is imported and rendered for the first time and schema is set before .open() is called
      if (this._isObject(elt.properties) && elt.properties.hasOwnProperty('schema')) {
        elt.autoValidate = true;
        elt.schema = this.schema;
      }
      // we need to assign elt.value here for when elt is imported and rendered for the first time and value is set before .open() is called
      this._setEltValue(elt);

      elt.addEventListener('value-changed', this._handleElementValueChanged.bind(this));

      this._clearPlaceholder();
      Polymer.dom(this.$.modalContent).insertBefore(elt, this.$.buttonContainer);

      Polymer.dom(this.$.messages).setAttribute('hidden', '');
      Polymer.dom(this.$.buttonContainer).removeAttribute('hidden');

      var isValid = elt.validate(false);
      this.toggleAttribute('disabled', !isValid, this.$.okButton);
    },

    _handleElementValueChanged: function(event) {
      var isValid = event.target.validate(true);
      this.toggleAttribute('disabled', !isValid, this.$.okButton);
    },

    _handleCancelButtonTap: function(event) {
      this.close("cancel");
    },

    _handleOkButtonTap: function(event) {
      this.close("ok");

      var elt = this._getRenderedElement();
      if (!elt) return;

      this.value = JSON.parse(JSON.stringify(elt.value));
      this.fire('value-changed', { value: this.value }, { bubbles: false });
    },

    _schemaChanged: function(newValue, oldValue) {
      // if schemaUrl is set ignore locally set schema
      if (this.schemaUrl) return;

      var elt = this._getRenderedElement();
      if (!elt) return;

      var schemaObj = newValue;
      if (this._isString(newValue)) {
        try {
          schemaObj = JSON.parse(newValue);
        } catch (e) { }
      }

      if (!this._isObject(schemaObj)) {
        this._setError('Schema must be an object that has properties property as object, or the JSON string of the former.');
        return;
      }

      if (!schemaObj.hasOwnProperty('properties')) {
        this._setError('Schema must be an object that has properties property as object, or the JSON string of the former.');
        return;
      }

      this._setError("");

      Polymer.dom(this.$.messages).setAttribute('hidden', '');

      elt.schema = schemaObj;
    },

    _valueChanged: function(newValue, oldValue) {
      var elt = this._getRenderedElement();
      if (!elt) return;

      Polymer.dom(this.$.messages).setAttribute('hidden', '');

      if (newValue === null || newValue === undefined) {
        elt.value = newValue;
        return;
      }

      var expValueType = this._getExpectedValueType(elt);

      var actValue = newValue;
      if (this._referenceTypeStrings.indexOf(expValueType) > -1 && this._isString(newValue)) {
        // parse JSON strings of arrays or objects
        try {
          actValue = JSON.parse(newValue);
        } catch (e) {
          this._setError('Invalid value json string: ' + e);
          return;
        }
      }

      var actValueType = this._getTypeString(actValue);
      if (actValueType !== expValueType) {
        this._setError('Value type mismatch. Type of ' + expValueType + ' was expected but ' + actValueType + ' was given instead.');
        return;
      }

      this._setError("");

      this._setEltValue(elt);
    },

    _handleCloseModal: function(event) {
      this.fire('close-modal', event.detail);
    },

    _handleQueryMatches: function(event) {
      return;
      var value = event.detail.value;
      var elt = this._getRenderedElement();
      if (!elt) return;
      if (!elt.properties.hasOwnProperty('_layout')) return;
      elt._layout = this.wide && value ? "horizontal" : "vertical";
    },

    // 
    // helper functions and properties
    //
    _placeholderText: '<div class="placeholder-text"></div><div class="placeholder-text mtsm"></div>',
    _referenceTypeStrings: ["[object Object]", "[object Array]"],

    _uiElts: {
      placeholderElt: null,
      renderedElt: null
    },

    _setPlaceholder: function() {
      var placeholderElt = this._uiElts.placeholderElt;
      if (!placeholderElt) {
        var placeholderElt = this.create('div');
        Polymer.dom(placeholderElt).innerHTML = this._placeholderText;
        this._uiElts.placeholderElt = placeholderElt;
      }

      Polymer.dom(this.$.modalContent).insertBefore(placeholderElt.childNodes[0], this.$.buttonContainer);
      Polymer.dom(this.$.modalContent).insertBefore(placeholderElt.childNodes[0], this.$.buttonContainer);
    },

    _clearPlaceholder: function() {
      var refNode = this.$.buttonContainer;
      var prevSib = Polymer.dom(refNode).previousSibling;
      while (prevSib !== null) {
        var tmp = prevSib;
        prevSib = Polymer.dom(prevSib).previousSibling;

        if (this._uiElts.placeholderElt.childNodes.length === 0) {
          this._uiElts.placeholderElt.appendChild(tmp);

        } else {
          var tmpRefNode = this._uiElts.placeholderElt.childNodes[0];
          this._uiElts.placeholderElt.insertBefore(tmp, tmpRefNode);
        }
      }
    },

    _computeImportUrl: function(elementName) {
      // compute importHref
      var importUrl = elementName;
      var fsIndex = importUrl.indexOf("/");
      if (fsIndex > 0) {
        importUrl = importUrl.substring(fsIndex + 1);
      }

      // expand relative name with name prefix
      if (importUrl.indexOf(".card") > 0) {
        var resolve = { namePrefix: "" };
        this.fire("resolve-name-prefix", resolve);
        var prefix = resolve.namePrefix;

        if (importUrl == "default.view") importUrl = "";
        importUrl = importUrl.replace("default.", "");
        importUrl = prefix + "/" + prefix + (importUrl ? ("-" + importUrl.replace(".", "-")) : "");
      }

      // load item-component from other component (itemComponent = component-name/item-component) or from localfolder (item-component)
      var compUrl = this.resolveUrl("../");
      if (document.URL.indexOf("/elements/designer-element/") >= 0) compUrl = "/components/"; // standalone designer preview?

      if (window.ComponentsBase != undefined) compUrl = window.ComponentsBase;

      importUrl = fsIndex >= 0 ? compUrl + elementName + ".html" : importUrl + ".html";
      return importUrl;
    },

    _computeElementName: function(importUrl) {
      var elementName = importUrl.substring(importUrl.lastIndexOf("/") + 1);
      elementName = elementName.replace(".html", "");
      return elementName;
    },

    _getRenderedElement: function() {
      var elt = Polymer.dom(this.$.modalContent).firstElementChild;
      if (elt.classList.contains("placeholder-text")) return null;
      if (elt.id === "buttonContainer") return null;
      return elt;
    },

    _hasError: function() {
      return this.$.messages.textContent.length > 0;
    },

    _setError: function(text) {
      Polymer.dom(this.$.messages).innerHTML = '';
      Polymer.dom(this.$.messages).classList.remove('info');
      Polymer.dom(this.$.messages).classList.add('error');
      Polymer.dom(this.$.messages).textContent = text;
      Polymer.dom(this.$.messages).removeAttribute('hidden');
    },

    _setInformation: function(text) {
      Polymer.dom(this.$.messages).innerHTML = '';
      Polymer.dom(this.$.messages).classList.remove('error');
      Polymer.dom(this.$.messages).classList.add('info');
      Polymer.dom(this.$.messages).textContent = text;
      Polymer.dom(this.$.messages).removeAttribute('hidden');
    },

    _setEltValue: function(elt) {
      var expValueType = this._getExpectedValueType(elt);
      if (this._referenceTypeStrings.indexOf(expValueType) > -1) {
        elt.value = JSON.parse(JSON.stringify(this.value));

      } else {
        elt.value = this.value;
      }
    },

    _getExpectedValueType: function(elt) {
      var value = elt.properties.value.value;
      if (this._isFunction(value)) {
        value = value();
      }
      return this._getTypeString(value);
    },

    _isString: function(obj) { return Object.prototype.toString.call(obj) === "[object String]"; },
    _isFunction: function(obj) { return Object.prototype.toString.call(obj) === "[object Function]"; },
    _isObject: function(obj) { return Object.prototype.toString.call(obj) === "[object Object]"; },
    _getTypeString: function(obj) { return Object.prototype.toString.call(obj); }
  });
</script>
