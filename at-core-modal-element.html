<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-core-style-classes/at-core-style-classes.html">
<link rel="import" href="../at-carbon-button/at-carbon-button.html">
<link rel="import" href="../at-core-modal/at-core-modal.html">
<link rel="import" href="../at-core-activity/at-core-activity.html">

<script src="lib/js-yaml.js"></script>

<dom-module id="at-core-modal-element">
  <template>
    <style include="at-core-style-classes">
      :host {
        display: block;
        box-sizing: border-box;
      }

      .cancel-btn {
        --at-carbon-button: {
          background-color: var(--at-light-blue);
          color: var(--at-background-text-color);
        }
      }

      .ok-btn {
        --at-carbon-button: {
          background-color: var(--at-green);
          color: var(--at-background-text-color);
        }
      }
    </style>

    <div id="eltPlaceholder" class="font-body1"></div>

    <at-core-modal id="coreModal" on-close-modal="_handleCloseModal">
      <div id="modalContent" class$="[[elementClass]]">
        <div id="buttonContainer" class="layout-horizontal layout-center-justified" hidden>
          <at-carbon-button raised class="cancel-btn" label="Cancel" on-tap="_handleCancelButtonTap"></at-carbon-button>
          <at-carbon-button id="okButton" disabled raised class="ok-btn" label="OK" on-tap="_handleOkButtonTap"></at-carbon-button>
        </div>
      </div>
    </at-core-modal>

    <at-core-activity id="schemaActivity" url="[[schemaUrl]]" content-type="text/plain" handle-as="text" on-response="_handleSchemaActivityResponse"
      on-error="_handleSchemaActivityError"></at-core-activity>
  </template>
</dom-module>
<script>
  Polymer({
    is: "at-core-modal-element",
    properties: {

      elementName: {
        type: String,
        value: ''
      },

      elementClass: {
        type: String,
        value: 'm'
      },

      schemaUrl: {
        type: String,
        value: ''
      },

      schema: {
        type: Object,
        value: function() {
          return {
            properties: {}
          };
        },
        observer: '_schemaChanged'
      },

      value: {
        type: Object,
        value: function() {
          return {};
        },
        observer: '_valueChanged'
      }
    },

    _placeholderText: '<div class="placeholder-text"></div><div class="placeholder-text mtsm"></div>',
    _referenceTypeStrings: ["[object Object]", "[object Array]"],

    observers: [
      '_initialize(elementName, schemaUrl)'
    ],

    _handleCloseModal: function(event) {
      this.fire('close-modal', event.detail);
    },

    ready: function() {
    },

    _initialize: function(elementName, schemaUrl) {
      Polymer.dom(this.$.eltPlaceholder).removeAttribute('hidden');
      this._setPlaceholder();

      if (!this._isString(elementName)) {
        this._setError('Component name is not a string.');
        return;
      }

      if (!elementName.length) {
        this._setInformation('Component name is empty.');
        return;
      }

      if (schemaUrl) {
        this.$.schemaActivity.generateRequest();

      } else {
        this._internalInitialize(elementName);
      }
    },

    _handleSchemaActivityError: function(error) {
      // do nothing; at-core-activity will display an error
    },

    _handleSchemaActivityResponse: function(response) {
      var newSchemaStr = response.detail;

      try {
        var newSchema = JSON.parse(newSchemaStr);
      } catch(e) {
        // try yaml
        try {
          newSchema = window.jsyaml.load(newSchemaStr);
        } catch (e) {
          this._setError('Data returned by remote service is not a json string nor yaml string.');
          return;
        }
      }

      if (!newSchema.hasOwnProperty('properties')) {
        this._setError('Schema must be an object that has properties property as object, or the JSON string of the former.');
        return;
      }

      var schemaChangedFn = this._schemaChanged;
      this._schemaChanged = function() { };
      this.schema = newSchema;
      this._schemaChanged = schemaChangedFn;

      this._internalInitialize(this.elementName);
    },

    _internalInitialize: function(elementName) {
      // compute importHref
      var importUrl = elementName;
      var fsIndex = importUrl.indexOf("/");
      if (fsIndex > 0) {
        importUrl = importUrl.substring(fsIndex + 1);
      }

      // expand relative name with name prefix
      if (importUrl.indexOf(".card") > 0) {
        var resolve = { namePrefix: "" };
        this.fire("resolve-name-prefix", resolve);
        var prefix = resolve.namePrefix;

        if (importUrl == "default.view") importUrl = "";
        importUrl = importUrl.replace("default.", "");
        importUrl = prefix + "/" + prefix + (importUrl ? ("-" + importUrl.replace(".", "-")) : "");
      }

      // load item-component from other component (itemComponent = component-name/item-component) or from localfolder (item-component)
      var compUrl = this.resolveUrl("../");
      if (document.URL.indexOf("/elements/designer-element/") >= 0) compUrl = "/components/"; // standalone designer preview?

      if (window.ComponentsBase != undefined) compUrl = window.ComponentsBase;

      importUrl = fsIndex >= 0 ? compUrl + elementName + ".html" : importUrl + ".html";

      var renderUI = this._renderUI.bind(this);
      var setError = this._setError.bind(this);

      this.importHref(importUrl, function(event) {
        var href = event.target.href;
        var elementName = href.substring(href.lastIndexOf("/") + 1);
        elementName = elementName.replace(".html", "");
        renderUI(elementName);

      }, function(event) {
        setError("An error occured while importing " + importUrl);

      }, true);
    },

    _renderUI: function(elementName) {
      var elt = this._getRenderedElement();
      if (elt) {
        Polymer.dom(Polymer.dom(elt).parentNode).removeChild(elt);
      }

      elt = this.create(elementName);

      if (!elt.properties.hasOwnProperty('value')) {
        this._setError('Element ' + elementName + ' does not have value property');
        return;
      }

      if (!this._isFunction(elt.validate)) {
        this._setError('Element ' + elementName + ' does not have validate function');
        return;
      }

      if (elt.properties.hasOwnProperty('schema')) {
        elt.autoValidate = true;
        elt.schema = this.schema;
      }

      // NOTE: There is no need to set value here because value is set in open function
      // elt.value = this.value;

      elt.addEventListener('value-changed', this._handleElementValueChanged.bind(this));

      Polymer.dom(this.$.modalContent).insertBefore(elt, this.$.buttonContainer);

      Polymer.dom(this.$.eltPlaceholder).setAttribute('hidden', '');
      Polymer.dom(this.$.buttonContainer).removeAttribute('hidden');

      var isValid = elt.validate();
      this.toggleAttribute('disabled', isValid, this.$.okButton);
    },

    _handleElementValueChanged: function(event) {
      var isValid = event.target.validate(true);
      this.toggleAttribute('disabled', !isValid, this.$.okButton);
    },

    _handleCancelButtonTap: function(event) {
      this.close("cancel");
    },

    _handleOkButtonTap: function(event) {
      this.close("ok");

      var elt = this._getRenderedElement();
      if (!elt) return;

      this.value = JSON.parse(JSON.stringify(elt.value));
      this.fire('value-changed', { value: this.value }, { bubbles: false });
    },

    _schemaChanged: function(newValue, oldValue) {
      // if schemaUrl is set ignore locally set schema
      if (this.schemaUrl) return;

      var schemaObj = newValue;
      if (this._isString(newValue)) {
        try {
          schemaObj = JSON.parse(newValue);
        } catch (e) { }
      }

      if (!this._isObject(schemaObj)) {
        this._setError('Schema must be an object that has properties property as object, or the JSON string of the former.');
        return;
      }

      if (!schemaObj.hasOwnProperty('properties')) {
        this._setError('Schema must be an object that has properties property as object, or the JSON string of the former.');
        return;
      }

      Polymer.dom(this.$.eltPlaceholder).setAttribute('hidden', '');

      var elt = this._getRenderedElement();
      if (!elt) return;

      elt.schema = schemaObj;
    },

    _valueChanged: function(newValue, oldValue) {
      var elt = this._getRenderedElement();
      if (!elt) return;

      Polymer.dom(this.$.eltPlaceholder).setAttribute('hidden', '');

      if (newValue === null || newValue === undefined) {
        elt.value = newValue;
        return;
      }

      var expValueType = this._getExpectedValueType(elt);

      var actValue = newValue;
      if (this._referenceTypeStrings.indexOf(expValueType) > -1 && this._isString(newValue)) {
        // parse JSON strings of arrays or objects
        try {
          actValue = JSON.parse(newValue);
        } catch (e) {
          this._setError('Invalid value json string: ' + e);
          return;
        }
      }

      var actValueType = this._getTypeString(actValue);
      if (actValueType !== expValueType) {
        this._setError('Value type mismatch. Type of ' + expValueType + ' was expected but ' + actValueType + ' was given instead.');
        return;
      }

      if (this._referenceTypeStrings.indexOf(actValueType) > -1) {
        elt.value = JSON.parse(JSON.stringify(actValue));

      } else {
        elt.value = actValue;
      }
    },

    // 
    // public api
    // 
    open: function() {
      var elt = this._getRenderedElement();
      if (!elt) return;

      var expValueType = this._getExpectedValueType(elt);
      if (this._referenceTypeStrings.indexOf(expValueType) > -1) {
        elt.value = JSON.parse(JSON.stringify(this.value));

      } else {
        elt.value = this.value;
      }

      // clear initial validation errors because validation errors should be displayed only as result of user interaction
      elt.validate(false);

      this.$.coreModal.open();
    },

    close: function(reason) {
      this.$.coreModal.close(reason);
    },

    // 
    // helper functions 
    // 
    _setPlaceholder: function() {
      Polymer.dom(this.$.eltPlaceholder).innerHTML = this._placeholderText;
      Polymer.dom(this.$.eltPlaceholder).classList.remove('error');
      Polymer.dom(this.$.eltPlaceholder).classList.remove('information');
      Polymer.dom(this.$.eltPlaceholder).textContent = '';
      Polymer.dom(this.$.eltPlaceholder).removeAttribute('hidden');
    },

    _setError: function(text) {
      Polymer.dom(this.$.eltPlaceholder).innerHTML = '';
      Polymer.dom(this.$.eltPlaceholder).classList.remove('info');
      Polymer.dom(this.$.eltPlaceholder).classList.add('error');
      Polymer.dom(this.$.eltPlaceholder).textContent = text;
      Polymer.dom(this.$.eltPlaceholder).removeAttribute('hidden');
    },

    _setInformation: function(text) {
      Polymer.dom(this.$.eltPlaceholder).innerHTML = '';
      Polymer.dom(this.$.eltPlaceholder).classList.remove('error');
      Polymer.dom(this.$.eltPlaceholder).classList.add('info');
      Polymer.dom(this.$.eltPlaceholder).textContent = text;
      Polymer.dom(this.$.eltPlaceholder).removeAttribute('hidden');
    },

    _getRenderedElement: function() {
      var elt = Polymer.dom(this.$.modalContent).firstElementChild;
      if (elt.id === "buttonContainer") return null;
      return elt;
    },

    _getExpectedValueType: function(elt) {
      var value = elt.properties.value.value;
      if (this._isFunction(value)) {
        value = value();
      }
      return this._getTypeString(value);
    },

    _isString: function(obj) { return Object.prototype.toString.call(obj) === "[object String]"; },
    _isFunction: function(obj) { return Object.prototype.toString.call(obj) === "[object Function]"; },
    _isObject: function(obj) { return Object.prototype.toString.call(obj) === "[object Object]"; },
    _getTypeString: function(obj) { return Object.prototype.toString.call(obj); }
  });
</script>
